<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShrinkiFly - Image Compressor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      background: #f9fafb;
      color: #111827;
      text-align: center;
      padding: 1rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 12px;
    }
    input, select {
      margin: 1rem 0;
      padding: 0.5rem;
      width: 100%;
      max-width: 300px;
      font-size: 1rem;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      background-color: #4F46E5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    #previewContainer img {
      margin-top: 1rem;
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.15);
    }
    .download-link {
      display: inline-block;
      margin-top: 1rem;
      font-weight: bold;
      color: #14B8A6;
      text-decoration: underline;
      cursor: pointer;
    }
    .size-info {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #6B7280;
    }
    #dropArea {
      display: none;
      border: 2px dashed #4F46E5;
      padding: 2rem;
      margin: 1rem 0;
      border-radius: 10px;
      cursor: pointer;
      background: #fff;
    }
    #dropArea.dragover {
      background-color: #e0e7ff;
    }
    #downloadAllBtn {
      display: none;
      margin-top: 1rem;
      background-color: #10B981;
    }
  </style>
</head>
<body>

<h1 style="font-size: 40px; color: rgb(79, 70, 229)">
  <img src="/images/compressed_ShrinkiflyLogo(100 x 100 px).jpeg" style="width: 30px; height: 30px;" alt="ShrinkiFly Logo"> ShrinkiFly
</h1>
<p>Fast & Easy Image Compression</p>
<p style="padding: .5em 3em;">Get faster batch uploads and downloads including drag and drop feature on the Pro, starting as low as $3/month</p>
<a href="https://barrosodigital.lemonsqueezy.com/buy/72c50ea5-394d-4b07-bdfc-20d32de9561f" target="_blank" rel="noopener noreferrer" 
   style="display:inline-block;margin-top:.25rem;padding:0.5rem 1.5rem;background:#037c03;color:white;border-radius:8px;text-decoration:none;">
   Upgrade To Pro
</a>

<p id="status">Mode: <strong id="mode">Free</strong></p>
<div id="license-status" style="margin-top: 10px; font-weight: bold; color: green;"></div>

<div id="dropArea">Drag and drop your image(s) here or click to select</div>
<input type="file" id="fileInput" accept="image/*" />

<label for="formatSelect">Select output format:</label>
<select id="formatSelect">
  <option value="image/jpeg">JPEG</option>
  <option value="image/png">PNG</option>
  <option value="image/webp">WebP</option>
</select>

<label for="qualityRange">Compression quality (JPEG/WebP): <span id="qualityValue">0.8</span></label>
<input type="range" id="qualityRange" min="0.1" max="1" step="0.05" value="0.8" />

<button id="compressBtn">Compress & Convert</button>
<button id="downloadAllBtn">Download All as ZIP</button>

<div id="previewContainer"></div>

<div style="margin-top:2rem">
  <label for="licenseKey">Have a Pro license?</label><br>
  <input type="text" id="licenseKey" placeholder="Enter your license key" style="width:100%;padding:0.5rem;" />
  <button id="unlockBtn" style="margin-top:1rem;">Unlock Pro</button>
</div>

<script defer>
  window.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('fileInput');
    const dropArea = document.getElementById('dropArea');
    const formatSelect = document.getElementById('formatSelect');
    const qualityRange = document.getElementById('qualityRange');
    const qualityValue = document.getElementById('qualityValue');
    const compressBtn = document.getElementById('compressBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const previewContainer = document.getElementById('previewContainer');
    const licenseKeyInput = document.getElementById("licenseKey");
    const unlockBtn = document.getElementById("unlockBtn");
    const modeText = document.getElementById("mode");
    const licenseStatus = document.getElementById("license-status");

    let isPro = false;
    let uploadedFiles = [];
    let compressedBlobs = [];

    // Load Pro status
    const savedLicense = JSON.parse(localStorage.getItem("shrinkifly_license"));
    if (savedLicense && savedLicense.valid) {
    if (savedLicense.key === "ADMIN-KEY-1234") {
      // Don’t auto-activate Admin mode on load — force Free mode instead
      activateFree();
    } else if (savedLicense.expiresAt) {
      const now = new Date();
      const expDate = new Date(savedLicense.expiresAt);
      if (expDate > now) {
        activatePro(savedLicense.key, savedLicense.expiresAt);
      } else {
        localStorage.removeItem("shrinkifly_license");
        activateFree();
      }
    } else {
      activatePro(savedLicense.key, savedLicense.expiresAt);
    }
  } else {
    activateFree();
  }


    unlockBtn.addEventListener("click", verifyLicense);

    function verifyLicense() {
      const key = licenseKeyInput.value.trim();
      if (!key) return alert("Enter a license key.");

      if (key === "ADMIN-KEY-1234") {
        activatePro(key, null, true);
        alert("Admin access granted.");
        return;
      }

      fetch("/api/validate-license", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ license_key: key })
})
.then(res => {
  if (!res.ok) throw new Error('Network response was not ok');
  return res.json();
})
.then(data => {
  // Assuming LemonSqueezy API response structure:
  // Check if license key is valid, not expired etc.
  if (data.data && data.data.attributes && data.data.attributes.status === 'active') {
    // Example: extract expiration date if available
    const expiresAt = data.data.attributes.expires_at || null;
    activatePro(key, expiresAt);
    alert("License validated and Pro mode activated!");
  } else {
    alert("Invalid or expired license key.");
  }
})
.catch(err => {
  console.error("License validation error:", err);
  alert("An error occurred validating your license.");
});

    }

    function activatePro(key, expiresAt, isAdmin = false) {
      isPro = true;
      modeText.innerText = isAdmin ? "Admin" : "Pro";
      fileInput.multiple = true;
      dropArea.style.display = 'block';
      enableDropArea();
      downloadAllBtn.style.display = 'inline-block';

      if (!isAdmin && expiresAt) {
        const expDate = new Date(expiresAt);
        const now = new Date();
        const diffMs = expDate - now;
        const hoursLeft = Math.floor(diffMs / (1000 * 60 * 60));
        const daysLeft = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        if (diffMs <= 0) {
          licenseStatus.textContent = "License expired.";
          isPro = false;
        } else {
          licenseStatus.textContent = daysLeft >= 1 ? 
            `License valid for ${daysLeft} day(s)` : 
            `License valid for ${hoursLeft} hour(s)`;
        }
      } else if (isAdmin) {
        licenseStatus.textContent = "Admin access: Unlimited";
      }
    
      localStorage.setItem("shrinkifly_license", JSON.stringify({ valid: true, key, expiresAt }));
    }

    function activateFree() {
      isPro = false;
      modeText.innerText = "Free";
      fileInput.multiple = false;
      dropArea.style.display = 'none';
      downloadAllBtn.style.display = 'none';
      licenseStatus.textContent = "";
      localStorage.removeItem("shrinkifly_license");
    }


    function enableDropArea() {
      dropArea.addEventListener('click', () => {
        fileInput.click();
      });

      dropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropArea.classList.add('dragover');
      });

      dropArea.addEventListener('dragleave', () => {
        dropArea.classList.remove('dragover');
      });

      dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        handleFiles(files);
      });
    }

    qualityRange.addEventListener('input', () => {
      qualityValue.textContent = qualityRange.value;
    });

    compressBtn.addEventListener('click', compressImages);

    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    function handleFiles(files) {
      let selectedFiles = Array.from(files);
      if (!isPro && selectedFiles.length > 1) {
        alert("Pro required for batch upload. Only first file used.");
        selectedFiles = [selectedFiles[0]];
      }
      uploadedFiles = selectedFiles;

      if (isPro) {
        compressImages();
      }
    }

    function compressImages() {
      if (!uploadedFiles.length) {
        alert('Please upload at least one image.');
        return;
      }

      previewContainer.innerHTML = '';
      compressedBlobs = [];

      uploadedFiles.forEach((file) => {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            const scale = Math.min(1, 1024 / img.width);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const format = formatSelect.value;
            const quality = format === 'image/png' ? undefined : parseFloat(qualityRange.value);
            canvas.toBlob(blob => {
              compressedBlobs.push({ blob, name: `compressed_${file.name.split('.')[0]}.${format.split('/')[1]}` });
              const url = URL.createObjectURL(blob);
              const previewImg = document.createElement('img');
              previewImg.src = url;
              previewContainer.appendChild(previewImg);

              const info = document.createElement('div');
              info.className = 'size-info';
              info.innerText = `Original: ${(file.size / 1024).toFixed(2)} KB | Compressed: ${(blob.size / 1024).toFixed(2)} KB`;
              previewContainer.appendChild(info);

              const link = document.createElement('a');
              link.href = url;
              link.download = `compressed_${file.name.split('.')[0]}.${format.split('/')[1]}`;
              link.className = 'download-link';
              link.innerText = 'Download';
              previewContainer.appendChild(link);
            }, format, quality);
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    downloadAllBtn.addEventListener('click', () => {
      const zip = new JSZip();
      compressedBlobs.forEach(({ blob, name }) => zip.file(name, blob));
      zip.generateAsync({ type: "blob" }).then(content => {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(content);
        link.download = "compressed_images.zip";
        link.click();
      });
    });
  });
</script>

</body>
</html>
